/**
 * Mission Control - Unified Dashboard
 * Displays all Gemini Phone services in a 2x2 grid
 * Port 3030 (default) or 5002 (Docker)
 */

require('dotenv').config();
const express = require('express');
const si = require('systeminformation');
const fs = require('fs');
const path = require('path');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 3030;

// Service URLs - Default to standard ports
// Voice App: 3000 (Docker mapping)
// Brain: 4000
// API: 3333
const VOICE_APP_URL = process.env.VOICE_APP_URL || 'http://127.0.0.1:3000';
const INFERENCE_URL = process.env.INFERENCE_URL || process.env.INFERENCE_BRAIN_URL || 'http://127.0.0.1:4000';
const API_SERVER_URL = process.env.API_SERVER_URL || 'http://127.0.0.1:3333';


// Middleware
app.use(express.json());
app.use(cors());

// Store for active calls and logs
let activeCalls = [];
let systemLogs = [];
const MAX_LOGS = 100;

// Add log entry
function addLog(level, service, message) {
  const entry = {
    timestamp: new Date().toISOString(),
    level,
    service,
    message
  };
  systemLogs.unshift(entry);
  if (systemLogs.length > MAX_LOGS) {
    systemLogs = systemLogs.slice(0, MAX_LOGS);
  }
}

// Main dashboard route
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Mission Control - Gemini Phone</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
        <style>
          :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --text: #e4e4e7;
            --text-dim: #a1a1aa;
            --accent: #8b5cf6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
          }
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
          }
          .header {
            height: 60px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            flex-shrink: 0;
          }
          .logo {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            background: linear-gradient(to right, #c084fc, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
          }
          .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 12px var(--success);
          }
          .service-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-dim);
          }
          .service-dots {
            display: flex;
            gap: 0.5rem;
          }
          .service-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
          }
          .service-dot.online {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
          }
          .service-dot.offline {
            background: var(--error);
            box-shadow: 0 0 8px var(--error);
          }
          .grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 60px);
          }
          .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          }
          .panel-header {
            padding: 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
          }
          .panel-content {
            padding: 1.25rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
          }
          
          /* Stats Grid */
          .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
          }
          .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
          }
          .stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
          }
          .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: white;
          }
          
          /* Controls */
          .control-group {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border: 1px solid var(--border);
          }
          .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
          }
          input[type=range] {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            appearance: none;
          }
          input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
          }
          select {
            width: 100%;
            background: #09090b;
            color: white;
            border: 1px solid var(--border);
            padding: 0.5rem;
            border-radius: 6px;
            font-family: inherit;
          }

          /* Buttons */
          .btn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
          }
          .btn {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
          }
          .btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
          }
          
          /* Monitors */
          .monitor-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
          }
          .progress-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 0 1rem;
            overflow: hidden;
          }
          .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.5s ease;
          }

          /* Logs */
          .log-container {
            flex: 1;
            background: #000;
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 0.75rem;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
          }
          .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
            display: flex;
            gap: 8px;
          }
          .log-time { color: var(--text-dim); }
          .log-service { color: var(--accent); }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logo">
            <span class="status-dot"></span>
            MISSION CONTROL v2.1
          </div>
          <div class="service-status">
            <span>Services:</span>
            <div class="service-dots">
              <span class="service-dot offline" id="dot-3cx" title="3CX PBX"></span>
              <span class="service-dot offline" id="dot-drachtio" title="Drachtio (SIP)"></span>
              <span class="service-dot offline" id="dot-freeswitch" title="FreeSWITCH (Media)"></span>
              <span class="service-dot offline" id="dot-voice" title="Voice App (Node.js)"></span>
              <span class="service-dot offline" id="dot-brain" title="Inference Brain"></span>
              <span class="service-dot offline" id="dot-api" title="API Server"></span>
              <span class="service-dot offline" id="dot-system" title="System Monitor"></span>
            </div>
          </div>
          <div id="clock" style="font-family: 'JetBrains Mono', monospace; color: var(--text-dim);">--:--:--</div>
        </div>

        <div class="grid">
          <!-- VOICE APP PANEL -->
          <div class="panel">
            <div class="panel-header">
              <span>üéôÔ∏è VOICE APP</span>
              <span class="status-badge" id="voice-status" style="color: var(--warning)">Checking...</span>
            </div>
            <div class="panel-content">
              <div class="stat-grid" style="margin-bottom: 1rem;">
                <div class="stat-card">
                  <div class="stat-label">System</div>
                  <div class="stat-value" id="voice-system">Ready</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Active Calls</div>
                  <div class="stat-value" id="voice-calls">0</div>
                </div>
              </div>

              <div class="control-group">
                <div class="stat-label">Voice Speed</div>
                <div class="slider-container">
                  <span style="font-size: 0.8rem">0.5x</span>
                  <input type="range" id="voice-speed" min="0.5" max="2.0" step="0.1" value="1.0" onchange="updateSpeed(this.value)">
                  <span id="speed-val" style="font-family: monospace; width: 40px">1.0x</span>
                </div>
              </div>

              <div style="margin-top: 1rem;">
                <div class="stat-label">CLI Access</div>
                <div style="font-size: 0.8rem; color: var(--success);">‚úì Enabled (Gemini Bridge)</div>
              </div>
            </div>
          </div>

          <!-- INFERENCE BRAIN PANEL -->
          <div class="panel">
            <div class="panel-header">
              <span>üß† INFERENCE BRAIN</span>
              <span class="status-badge" id="inference-status" style="color: var(--warning)">Checking...</span>
            </div>
            <div class="panel-content">
              <div class="stat-grid" style="margin-bottom: 1rem;">
                <div class="stat-card">
                  <div class="stat-label">Sessions</div>
                  <div class="stat-value" id="ai-sessions">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Load</div>
                  <div class="stat-value" id="ai-load">--%</div>
                </div>
              </div>

              <div class="control-group">
                <div class="stat-label">Active Model</div>
                <select id="model-select" onchange="updateModel(this.value)">
                  <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                  <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                  <option value="gemini-1.5-pro">gemini-1.5-pro</option>
                  <option value="gemini-1.5-flash">gemini-1.5-flash</option>
                </select>
              </div>

               <div style="flex: 1; margin-top: 1rem; display: flex; flex-direction: column; overflow: hidden;">
                <div class="stat-label">Activity Log</div>
                <div id="brain-log" class="log-container" style="background: rgba(0,0,0,0.3); border: none;">
                  <div class="log-entry"><span class="log-time">--:--</span> Waiting for thoughts...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- GEMINI API SERVER -->
          <div class="panel">
            <div class="panel-header">
              <span>‚ö° GEMINI API SERVER</span>
              <span class="status-badge" id="api-status" style="color: var(--warning)">Checking...</span>
            </div>
            <div class="panel-content">
              <div class="stat-grid">
                <div class="stat-card">
                  <div class="stat-label">Status</div>
                  <div class="stat-value" style="color: var(--success); font-size: 1.2rem;">OPERATIONAL</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Connection</div>
                  <div class="stat-value">HTTP/REST</div>
                </div>
              </div>

              <div class="btn-grid">
                <button class="btn" onclick="apiAction('ping')">üì° Ping</button>
                <button class="btn" onclick="apiAction('docker-check')">üê≥ Docker</button>
                <button class="btn" onclick="apiAction('git-status')">üêô Git</button>
                <button class="btn" onclick="apiAction('list-files')">üìÇ Files</button>
                <button class="btn" onclick="apiAction('weather')">‚òÄÔ∏è Weather</button>
                <button class="btn" onclick="apiAction('network')">üñß Network</button>
                <button class="btn" onclick="apiAction('disk')">üíæ Disk</button>
                <button class="btn" onclick="apiAction('ports')">üîå Ports</button>
                <button class="btn" onclick="apiAction('uptime')">‚è±Ô∏è Uptime</button>
                <button class="btn" onclick="apiAction('joke')">üòÑ Joke</button>
                <button class="btn" onclick="apiAction('fortune')">üîÆ Fortune</button>
                <button class="btn" onclick="apiAction('system-info')">‚ÑπÔ∏è Info</button>
              </div>

              <div id="api-result" style="margin-top: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: monospace; font-size: 0.8rem; min-height: 40px; color: #a5b4fc; max-height: 100px; overflow-y: auto;">
                Ready for commands...
              </div>
            </div>
          </div>

          <!-- SYSTEM MONITOR -->
          <div class="panel">
            <div class="panel-header">
              <span>üìä SYSTEM MONITOR</span>
              <div style="font-size: 0.75rem; color: var(--success);">LIVE</div>
            </div>
            <div class="panel-content">
              <!-- CPU -->
              <div class="monitor-row">
                <span style="width: 40px">CPU</span>
                <div class="progress-bar"><div class="progress-fill" id="bar-cpu"></div></div>
                <span id="val-cpu">--%</span>
              </div>
              
              <!-- GPU -->
              <div class="monitor-row">
                <span style="width: 40px">GPU</span>
                <div class="progress-bar"><div class="progress-fill" id="bar-gpu" style="background: #ec4899"></div></div>
                <span id="val-gpu">--%</span>
              </div>

              <!-- RAM -->
              <div class="monitor-row">
                <span style="width: 40px">RAM</span>
                <div class="progress-bar"><div class="progress-fill" id="bar-mem" style="background: #3b82f6"></div></div>
                <span id="val-mem">--%</span>
              </div>

              <!-- TEMP -->
              <div class="monitor-row">
                <span style="width: 40px">TMP</span>
                <div class="progress-bar"><div class="progress-fill" id="bar-temp" style="background: #f59e0b"></div></div>
                <span id="val-temp">--¬∞C</span>
              </div>

              <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; margin-top: 1rem;">
                <div class="stat-label">Shared System Logs</div>
                <div id="sys-logs" class="log-container">
                  <!-- Logs -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          // Clock
          setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
          }, 1000);

          // Update Helpers
          function setStatus(id, online) {
            const el = document.getElementById(id);
            if(online) {
              el.innerText = 'ONLINE';
              el.style.color = 'var(--success)';
            } else {
              el.innerText = 'OFFLINE';
              el.style.color = 'var(--error)';
            }
          }

          // Voice App
          async function updateVoice() {
            try {
              // Try health first
              const h = await fetch('/api/proxy/voice/health');
              if(h.ok) {
                setStatus('voice-status', true);
                document.getElementById('dot-voice').className = 'service-dot online';
              } else throw new Error('Unhealthy');

              // Get Config for speed
              const c = await fetch('/api/proxy/voice/api/config?device=default'); // Assuming default device exists
              const conf = await c.json();
              if(conf.success) {
                 const speed = conf.config.speed || 1.0;
                 document.getElementById('voice-speed').value = speed;
                 document.getElementById('speed-val').innerText = speed + 'x';
              }
            } catch(e) {
              setStatus('voice-status', false);
              document.getElementById('dot-voice').className = 'service-dot offline';
            }
          }

          async function updateSpeed(val) {
            document.getElementById('speed-val').innerText = val + 'x';
            try {
              // Get first device to update
              const d = await fetch('/api/proxy/voice/api/devices');
              const dd = await d.json();
              if(dd.devices && dd.devices.length > 0) {
                await fetch('/api/proxy/voice/api/config/speed', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ device: dd.devices[0].extension, speed: parseFloat(val) })
                });
              }
            } catch(e) { console.error(e); }
          }

          // Inference Brain
          async function updateInference() {
            try {
              const res = await fetch('/api/proxy/inference/stats');
              const data = await res.json();
              if(data.success) {
                setStatus('inference-status', true);
                document.getElementById('dot-brain').className = 'service-dot online';
                document.getElementById('ai-sessions').innerText = data.sessions;
                document.getElementById('model-select').value = data.model;
                
                // Mock load for now if not in stats
                document.getElementById('ai-load').innerText = (data.cpu || 0) + '%';
              }
            } catch(e) {
              setStatus('inference-status', false);
              document.getElementById('dot-brain').className = 'service-dot offline';
            }
          }

          async function updateModel(model) {
            try {
              await fetch('/api/proxy/inference/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ model })
              });
            } catch(e) { alert('Failed to change model'); }
          }

          const PROMPTS = {
            'docker-check': 'Check status of all docker containers and return a summary.',
            'git-status': 'Check git status and recent commits.',
            'list-files': 'List files in the current directory.',
            'weather': 'What is the weather like?',
            'network': 'Check network interfaces and IP addresses.',
            'disk': 'Check disk usage.',
            'ports': 'Check active listening ports.',
            'uptime': 'Check system uptime.'
          };

          async function apiAction(action) {
            const out = document.getElementById('api-result');
            out.innerText = 'Running...';
            
            try {
              let res;
              if(PROMPTS[action]) {
                // Send as prompt to Gemini
                res = await fetch('/api/proxy/api/ask', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ prompt: PROMPTS[action] })
                });
                const d = await res.json();
                out.innerText = d.response || d.error;
              } else {
                // Standard Endpoint
                res = await fetch('/api/proxy/api/' + action);
                const d = await res.json();
                out.innerText = JSON.stringify(d, null, 2);
              }
              setStatus('api-status', true);
              document.getElementById('dot-api').className = 'service-dot online';
            } catch(e) {
              out.innerText = 'Error: ' + e.message;
              setStatus('api-status', false);
              document.getElementById('dot-api').className = 'service-dot offline';
            }
          }

          // Check API status periodically
          async function updateApiStatus() {
            try {
              const res = await fetch('/api/proxy/api/health');
              if(res.ok) {
                setStatus('api-status', true);
                document.getElementById('dot-api').className = 'service-dot online';
              } else throw new Error('Unhealthy');
            } catch(e) {
              setStatus('api-status', false);
              document.getElementById('dot-api').className = 'service-dot offline';
            }
          }

          async function updateSystem() {
            try {
              const res = await fetch('/api/system-stats');
              const data = await res.json();
              
              // CPU
              document.getElementById('val-cpu').innerText = data.cpu + '%';
              document.getElementById('bar-cpu').style.width = data.cpu + '%';
              
              // RAM
              document.getElementById('val-mem').innerText = data.memory + '%';
              document.getElementById('bar-mem').style.width = data.memory + '%';
              
              // GPU
              document.getElementById('val-gpu').innerText = data.gpu + '%';
              document.getElementById('bar-gpu').style.width = data.gpu + '%';
              
              // Temp
              document.getElementById('val-temp').innerText = data.temp + '¬∞C';
              document.getElementById('bar-temp').style.width = Math.min(data.temp, 100) + '%';
              
              document.getElementById('dot-system').className = 'service-dot online';
            } catch(e) {
              document.getElementById('dot-system').className = 'service-dot offline';
            }
          }

          async function updateLogs() {
            try {
               const res = await fetch('/api/logs');
               const data = await res.json();
               
               // 1. Shared System Logs (All)
               const html = data.logs.slice(0, 50).map(l => 
                 \`<div class="log-entry">
                    <span class="log-time">\${new Date(l.timestamp).toLocaleTimeString()}</span>
                    <span class="log-service" style="color: \${l.level === 'ERROR' ? '#ef4444' : '#8b5cf6'}">[\${(l.service || 'SYS').replace('INFERENCE-BRAIN', 'BRAIN')}]</span>
                    <span>\${l.message}</span>
                  </div>\`
               ).join('');
               document.getElementById('sys-logs').innerHTML = html;

               // 2. Inference Brain Logs (Filtered)
               const brainLogs = data.logs.filter(l => l.service === 'INFERENCE-BRAIN' || l.service === 'INFERENCE');
               const brainHtml = brainLogs.slice(0, 20).map(l => 
                 \`<div class="log-entry">
                    <span class="log-time">\${new Date(l.timestamp).toLocaleTimeString()}</span>
                    <span style="color: #ec4899;">\${l.message}</span>
                  </div>\`
               ).join('');
               
               const brainLogEl = document.getElementById('brain-log');
               if(brainLogEl) {
                 brainLogEl.innerHTML = brainHtml || '<div class="log-entry" style="color:#64748b">Waiting for thoughts...</div>';
               }

            } catch(e) {}
          }

          // Docker container health check
          async function updateDockerStatus() {
            try {
              const res = await fetch('/api/docker-health');
              const data = await res.json();
              
              if(data.success) {
                document.getElementById('dot-drachtio').className = data.drachtio ? 'service-dot online' : 'service-dot offline';
                document.getElementById('dot-freeswitch').className = data.freeswitch ? 'service-dot online' : 'service-dot offline';
              }
            } catch(e) {
              document.getElementById('dot-drachtio').className = 'service-dot offline';
              document.getElementById('dot-freeswitch').className = 'service-dot offline';
            }
          }

          setInterval(update3CXStatus, 5000);
          setInterval(updateDockerStatus, 5000);

          setInterval(updateVoice, 5000);
          setInterval(updateInference, 5000);
          setInterval(updateApiStatus, 5000);
          setInterval(updateSystem, 2000);
          setInterval(updateLogs, 2000);
          
          update3CXStatus(); updateDockerStatus(); updateVoice(); updateInference(); updateApiStatus(); updateSystem(); updateLogs();
        </script>
      </body>
    </html>
  `);
});

// ============================================
// PROXY ROUTES
// ============================================

const proxyRequest = async (url, options = {}) => {
  try {
    const response = await fetch(url, options);
    // if (!response.ok) throw new Error(`HTTP ${response.status}`); // Don't throw, let client handle
    return await response.json();
  } catch (err) {
    console.error(`Proxy Error to ${url}:`, err.message);
    throw err;
  }
};

// Voice App Proxies
app.use('/api/proxy/voice', async (req, res) => {
  const targetPath = req.path === '/' ? '' : req.path; // Strip leading slash issues
  const url = `${VOICE_APP_URL}${targetPath}`;
  try {
    const opts = {
      method: req.method,
      headers: { 'Content-Type': 'application/json' },
    };
    if (req.method !== 'GET') opts.body = JSON.stringify(req.body);

    const data = await proxyRequest(url, opts);
    res.json(data);
  } catch (e) {
    res.status(502).json({ error: 'Voice App Unreachable' });
  }
});

// Inference Proxies
app.use('/api/proxy/inference', async (req, res) => {
  const targetPath = req.path === '/' ? '' : req.path;
  const url = `${INFERENCE_URL}${targetPath}`;
  try {
    const opts = {
      method: req.method, // Forward POST/GET
      headers: { 'Content-Type': 'application/json' },
    };
    if (req.method !== 'GET') opts.body = JSON.stringify(req.body);

    const data = await proxyRequest(url, opts);
    res.json(data);
  } catch (e) {
    res.status(502).json({ error: 'Inference Brain Unreachable' });
  }
});

// API Server Proxies
app.use('/api/proxy/api', async (req, res) => {
  const targetPath = req.path === '/' ? '' : req.path;
  const url = `${API_SERVER_URL}${targetPath}`;
  try {
    const opts = {
      method: req.method,
      headers: { 'Content-Type': 'application/json' },
    };
    if (req.method !== 'GET') opts.body = JSON.stringify(req.body);

    const data = await proxyRequest(url, opts);
    res.json(data);
  } catch (e) {
    res.status(502).json({ error: 'API Server Unreachable' });
  }
});

// ============================================
// LOCAL API ROUTES
// ============================================

app.get('/api/system-stats', async (req, res) => {
  try {
    const cpu = await si.currentLoad();
    const mem = await si.mem();
    const graphics = await si.graphics();
    const temp = await si.cpuTemperature();

    // Attempt to find GPU load - Iterate to find the weird NVIDIA/dedicated ones
    let gpuLoad = 0;
    if (graphics.controllers && graphics.controllers.length > 0) {
      // Try to find one with utilizationGpu
      const activeGpu = graphics.controllers.find(c => c.utilizationGpu > 0) || graphics.controllers[0];
      gpuLoad = activeGpu.utilizationGpu || 0;

      // Fallback: if 0, check if we have memory used on it
      if (gpuLoad === 0 && activeGpu.memoryTotal > 0) {
        // This is a rough proxy if load isn't available
        const vramPercent = (activeGpu.memoryUsed / activeGpu.memoryTotal) * 100;
        if (vramPercent > 0) gpuLoad = vramPercent;
      }
    }

    res.json({
      cpu: cpu.currentLoad.toFixed(1),
      memory: ((mem.used / mem.total) * 100).toFixed(1),
      gpu: typeof gpuLoad === 'number' ? gpuLoad.toFixed(1) : 0,
      temp: temp.main || 0
    });
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch system stats' });
  }
});

// Docker health check endpoint
app.get('/api/docker-health', async (req, res) => {
  const { exec } = require('child_process');
  const util = require('util');
  const execPromise = util.promisify(exec);

  try {
    const { stdout } = await execPromise('docker ps --format "{{.Names}},{{.Status}}" --filter "name=drachtio" --filter "name=freeswitch" --filter "name=voice-app"');
    const containers = {};

    stdout.trim().split('\n').forEach(line => {
      if (line) {
        const [name, status] = line.split(',');
        containers[name] = status.toLowerCase().includes('up');
      }
    });

    res.json({
      success: true,
      drachtio: containers.drachtio || false,
      freeswitch: containers.freeswitch || false,
      voiceApp: containers['voice-app'] || false
    });
  } catch (error) {
    res.json({
      success: false,
      drachtio: false,
      freeswitch: false,
      voiceApp: false
    });
  }
});

// Logs API - Aggregated
app.get('/api/logs', async (req, res) => {
  try {
    let combinedLogs = [...systemLogs];

    // Fetch Voice App Logs
    try {
      const vRes = await fetch(`${VOICE_APP_URL}/api/logs`);
      const vData = await vRes.json();
      if (vData.logs) combinedLogs = combinedLogs.concat(vData.logs);
    } catch (e) { }

    // Fetch Inference Logs
    try {
      const iRes = await fetch(`${INFERENCE_URL}/logs`);
      const iData = await iRes.json();
      if (iData.logs) combinedLogs = combinedLogs.concat(iData.logs);
    } catch (e) { }

    // Fetch API Server Logs
    try {
      const aRes = await fetch(`${API_SERVER_URL}/logs`);
      const aData = await aRes.json();
      if (aData.logs) combinedLogs = combinedLogs.concat(aData.logs);
    } catch (e) { }

    // Sort by timestamp desc
    combinedLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    // Limit
    combinedLogs = combinedLogs.slice(0, 100);

    res.json({ logs: combinedLogs });
  } catch (e) {
    res.json({ logs: systemLogs });
  }
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`Mission Control started on port ${PORT}`);
  addLog('INFO', 'MISSION-CONTROL', 'Server started on port ' + PORT);
});
