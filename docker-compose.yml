# CRITICAL: All containers must use network_mode: host
# Docker bridge networking causes FreeSWITCH to advertise internal IPs
# in SDP, making RTP unreachable from external callers.

services:
  drachtio:
    image: drachtio/drachtio-server:latest
    container_name: drachtio
    restart: unless-stopped
    network_mode: host
    command: >
      drachtio --contact "sip:*:5060;transport=tcp,udp" --secret ${DRACHTIO_SECRET:-cymru} --port 9022 --loglevel info

  freeswitch:
    image: drachtio/drachtio-freeswitch-mrf:latest
    container_name: freeswitch
    restart: unless-stopped
    network_mode: host
    command: >
      freeswitch --sip-port 5080 --rtp-range-start 30000 --rtp-range-end 30100 --ext-rtp-ip ${EXTERNAL_IP:-127.0.0.1} --ext-sip-ip ${EXTERNAL_IP:-127.0.0.1} --advertise-external-ip
    volumes:
      - ./data/recordings:/app/recordings
    environment:
      - EXTERNAL_IP=${EXTERNAL_IP:-127.0.0.1}

  voice-app:
    build: ./voice-app
    container_name: voice-app
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    volumes:
      - ./voice-app/audio:/app/audio
      - ./voice-app/config:/app/config
      - ./data/recordings:/app/recordings
    depends_on:
      - drachtio
      - freeswitch

  mission-control:
    build: ./mission-control
    container_name: mission-control
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    volumes:
      - ./data/mission-control:/app/data
      - .env:/app/.env
    environment:
      - PORT=3030
      - VOICE_APP_URL=http://localhost:3000
      - API_SERVER_URL=http://localhost:3333
      - INFERENCE_URL=http://localhost:4000
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - MISSION_CONTROL_GEMINI_KEY=${MISSION_CONTROL_GEMINI_KEY}
      - GOOGLE_API_KEY=${GEMINI_API_KEY}

  inference-server:
    build: ./inference-server
    container_name: inference-server
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    environment:
      - PORT=4000
      - GEMINI_API_URL=http://localhost:3333
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GPU_VENDOR=none

  gemini-api-server:
    build: ./gemini-api-server
    container_name: gemini-api-server
    restart: unless-stopped
    network_mode: host
    volumes:
      - /root/.gemini:/root/.gemini
    env_file:
      - .env
    environment:
      - PORT=3333
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PAI_DIR=/root/.gemini
