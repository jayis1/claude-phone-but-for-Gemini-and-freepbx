# CRITICAL: All containers must use network_mode: host
# Docker bridge networking causes FreeSWITCH to advertise internal IPs
# in SDP, making RTP unreachable from external callers.

services:
  drachtio:
    image: drachtio/drachtio-server:latest
    container_name: drachtio
    restart: unless-stopped
    network_mode: host
    command: >
      drachtio --contact "sip:*:5060;transport=tcp,udp" --external-ip ${EXTERNAL_IP} --secret ${DRACHTIO_SECRET:-cymru} --port 9022 --loglevel info
    # Ports (for reference - host mode doesn't need port mapping):
    # - 5060: SIP UDP/TCP
    # - 9022: Admin/App Port

  freeswitch:
    image: drachtio/drachtio-freeswitch-mrf:latest
    container_name: freeswitch
    restart: unless-stopped
    network_mode: host
    command: >
      freeswitch --sip-port 5080 --rtp-range-start 30000 --rtp-range-end 30100 --ext-rtp-ip ${EXTERNAL_IP} --ext-sip-ip ${EXTERNAL_IP} --advertise-external-ip
    environment:
      # CRITICAL: Set this to your server's LAN IP
      # This IP goes into SDP packets so 3CX knows where to send audio
      # Note: drachtio-freeswitch-mrf only accepts CLI flags, not env vars
      - EXTERNAL_IP=${EXTERNAL_IP}
    # Ports (for reference):
    # - 8021: ESL (Event Socket Library)
    # - 5080: Internal SIP
    # - 30000-30100: RTP Audio (changed from 20000-20100 to avoid conflict with 3CX SBC)

  voice-app:
    build: ./voice-app
    container_name: voice-app
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    volumes:
      # Audio files directory for TTS playback
      - ./voice-app/audio:/app/audio
      # Device configurations
      - ./voice-app/config:/app/config
    depends_on:
      - drachtio
      - freeswitch
      - gemini-api-server
    # Ports (for reference):
    # - 3000: HTTP API
    # - 3001: WebSocket for audio streaming

  gemini-api-server:
    build: ./gemini-api-server
    container_name: gemini-api-server
    restart: unless-stopped
    network_mode: host
    environment:
      # Pass through model selection
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-pro}
      # Pass through auth if needed (though sandbox usually has its own or needs it mounted)
      # The sandbox might need ~/.gemini mounted?
      # User said: "you can run the Gemini CLI directly... docker run ... sandbox"
      # And "run the published sandbox image".
      # For auth, typically we mount the config.
      # Let's check how the user runs it: "gemini --sandbox" implies local auth is used.
      # If running in docker, we need to provide credentials.
      # We'll map the .gemini directory from host if it exists.
    volumes:
      - ${HOME}/.gemini:/root/.gemini
      - ${HOME}/.gemini-phone/config.json:/root/.gemini-phone/config.json
    # Ports (for reference):
    # - 3333: HTTP API (host mode)
